version: 0.2

env:
  shell: bash

phases:
  install:
    commands:
      - echo "Installing dependencies..."
      - yum install -y unzip python3 jq
      - pip3 install boto3 pyyaml
      - echo "Installing Terraform..."
      - curl -O https://releases.hashicorp.com/terraform/1.14.3/terraform_1.14.3_linux_amd64.zip
      - unzip -o terraform_1.14.3_linux_amd64.zip -d /tmp/tf-bin
      - mv /tmp/tf-bin/terraform /usr/local/bin/
      - terraform version

  build:
    commands:
      - echo "Provisioning Pipelines from deploy/ directory structure..."
      - |
        # Get central account ID for state bucket
        CENTRAL_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        TF_STATE_BUCKET="terraform-state-${CENTRAL_ACCOUNT_ID}"
        TF_STATE_REGION="us-east-1"

        echo "Using state bucket: $TF_STATE_BUCKET"

        # Process each region directory in deploy/
        for region_dir in deploy/*/; do
            [ -d "$region_dir" ] || continue

            # Extract region name from directory path (e.g., deploy/fedramp-us-east-1/ -> fedramp-us-east-1)
            REGION_NAME=$(basename "$region_dir")

            echo "=========================================="
            echo "Processing region: $REGION_NAME"
            echo "=========================================="

            # 1. Check for regional.yaml in this region
            if [ -f "${region_dir}regional.yaml" ]; then
                echo "Found regional.yaml for $REGION_NAME"

                REGIONAL_CONFIG="${region_dir}regional.yaml"

                # Extract configuration from YAML
                TARGET_REGION=$(python3 -c "import yaml; config = yaml.safe_load(open('$REGIONAL_CONFIG')); print(config.get('region', config.get('target_region', 'us-east-1')))")
                TARGET_ACCOUNT_ID=$(python3 -c "import yaml; config = yaml.safe_load(open('$REGIONAL_CONFIG')); print(config.get('account_id', ''))")
                TARGET_ALIAS=$(python3 -c "import yaml; config = yaml.safe_load(open('$REGIONAL_CONFIG')); print(config.get('alias', ''))")

                echo "  Target Region: $TARGET_REGION"
                [ -n "$TARGET_ACCOUNT_ID" ] && echo "  Target Account ID: $TARGET_ACCOUNT_ID"
                [ -n "$TARGET_ALIAS" ] && echo "  Target Alias: $TARGET_ALIAS"

                echo "Provisioning Regional Cluster Pipeline for $REGION_NAME..."
                cd terraform/config/pipeline-regional-cluster

                terraform init \
                    -backend-config="bucket=$TF_STATE_BUCKET" \
                    -backend-config="key=pipelines/regional-${REGION_NAME}.tfstate" \
                    -backend-config="region=$TF_STATE_REGION" \
                    -backend-config="dynamodb_table=terraform-locks"

                # Build terraform apply command with variables
                TF_VARS="-var=github_repo_owner=${GITHUB_REPO_OWNER} -var=github_repo_name=${GITHUB_REPO_NAME} -var=github_branch=${GITHUB_BRANCH} -var=region=${TARGET_REGION}"
                [ -n "$TARGET_ACCOUNT_ID" ] && TF_VARS="$TF_VARS -var=target_account_id=${TARGET_ACCOUNT_ID}"
                [ -n "$TARGET_ALIAS" ] && TF_VARS="$TF_VARS -var=target_alias=${TARGET_ALIAS}"

                terraform apply -auto-approve $TF_VARS

                cd ../../..
                echo "✅ Regional pipeline created for $REGION_NAME"
            else
                echo "No regional.yaml found in $region_dir, skipping regional pipeline..."
            fi

            # 2. Check for management/*.yaml files in this region
            if [ -d "${region_dir}management" ]; then
                echo "Checking for management cluster configs in $REGION_NAME..."

                for mc_config in ${region_dir}management/*.yaml; do
                    [ -e "$mc_config" ] || continue

                    # Extract cluster name from filename (e.g., mc01-us-east-1.yaml -> mc01-us-east-1)
                    CLUSTER_NAME=$(basename "$mc_config" .yaml)

                    echo "Found management cluster config: $CLUSTER_NAME"

                    # Extract configuration from YAML
                    TARGET_REGION=$(python3 -c "import yaml; config = yaml.safe_load(open('$mc_config')); print(config.get('region', config.get('target_region', 'us-east-1')))")
                    TARGET_ACCOUNT_ID=$(python3 -c "import yaml; config = yaml.safe_load(open('$mc_config')); print(config.get('account_id', ''))")
                    TARGET_ALIAS=$(python3 -c "import yaml; config = yaml.safe_load(open('$mc_config')); print(config.get('alias', ''))")

                    echo "  Target Region: $TARGET_REGION"
                    [ -n "$TARGET_ACCOUNT_ID" ] && echo "  Target Account ID: $TARGET_ACCOUNT_ID"
                    [ -n "$TARGET_ALIAS" ] && echo "  Target Alias: $TARGET_ALIAS"

                    echo "Provisioning Management Cluster Pipeline for $CLUSTER_NAME in $REGION_NAME..."
                    cd terraform/config/pipeline-management-cluster

                    terraform init \
                        -backend-config="bucket=$TF_STATE_BUCKET" \
                        -backend-config="key=pipelines/management-${REGION_NAME}-${CLUSTER_NAME}.tfstate" \
                        -backend-config="region=$TF_STATE_REGION" \
                        -backend-config="dynamodb_table=terraform-locks"

                    # Build terraform apply command with variables
                    TF_VARS="-var=github_repo_owner=${GITHUB_REPO_OWNER} -var=github_repo_name=${GITHUB_REPO_NAME} -var=github_branch=${GITHUB_BRANCH} -var=region=${TARGET_REGION}"
                    [ -n "$TARGET_ACCOUNT_ID" ] && TF_VARS="$TF_VARS -var=target_account_id=${TARGET_ACCOUNT_ID}"
                    [ -n "$TARGET_ALIAS" ] && TF_VARS="$TF_VARS -var=target_alias=${TARGET_ALIAS}"

                    terraform apply -auto-approve $TF_VARS

                    cd ../../..
                    echo "✅ Management pipeline created for $CLUSTER_NAME in $REGION_NAME"
                done
            else
                echo "No management/ directory in $region_dir, skipping management pipelines..."
            fi

            echo ""
        done

  post_build:
    commands:
      - echo "Pipeline provisioning complete."
      - echo "Check AWS Console CodePipeline to see created pipelines."

artifacts:
  files:
    - '**/*'
