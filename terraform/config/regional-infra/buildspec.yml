version: 0.2

env:
  shell: bash

phases:
  install:
    commands:
      - echo "Installing dependencies..."
      - yum install -y unzip python3 jq
      - pip3 install boto3 pyyaml
      - echo "Installing Terraform..."
      - curl -O https://releases.hashicorp.com/terraform/1.14.3/terraform_1.14.3_linux_amd64.zip
      - unzip -o terraform_1.14.3_linux_amd64.zip -d /tmp/tf-bin
      - mv /tmp/tf-bin/terraform /usr/local/bin/
      - echo "Installing kubectl..."
      - curl -LO "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl"
      - chmod +x kubectl
      - mv kubectl /usr/local/bin/
      - chmod +x scripts/validate-argocd-config.sh scripts/bootstrap-argocd.sh

  build:
    commands:
      - echo "Processing Management Cluster Configurations..."
      - |
        process_target() {
            local MANAGEMENT_ACCOUNT_ID=$1
            local REGION=$2
            local ALIAS=$3

            echo "---------------------------------------------------"
            echo "Processing Target: $ALIAS ($MANAGEMENT_ACCOUNT_ID) in $REGION"

            # Get Regional Account ID BEFORE assuming role
            REGIONAL_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            echo "Regional Account ID: $REGIONAL_ACCOUNT_ID"

            # Define Role ARN
            local ROLE_ARN="arn:aws:iam::${MANAGEMENT_ACCOUNT_ID}:role/OrganizationAccountAccessRole"
            
            # Export Variables for Makefile / Terraform Backend
            # State is stored in the Regional Account (Current Account), but we use the Management Alias in the key
            export TF_STATE_BUCKET="terraform-state-management-${REGIONAL_ACCOUNT_ID}"
            export TF_STATE_KEY="management-cluster/${ALIAS}.tfstate"
            
            # Dynamically detect bucket region (uses Regional Creds)
            BUCKET_REGION=$(aws s3api get-bucket-location --bucket $TF_STATE_BUCKET --query LocationConstraint --output text)
            if [ "$BUCKET_REGION" == "None" ] || [ -z "$BUCKET_REGION" ]; then BUCKET_REGION="us-east-1"; fi
            export TF_STATE_REGION=$BUCKET_REGION
            
            export TF_STATE_DYNAMODB_TABLE="terraform-locks-management"

            # Export Terraform Variables for Management Cluster
            export TF_VAR_app_code="infra"
            export TF_VAR_service_phase="prod"
            export TF_VAR_cost_center="000"
            export TF_VAR_cluster_id="${ALIAS}"
            export TF_VAR_regional_aws_account_id="${REGIONAL_ACCOUNT_ID}"
            export TF_VAR_repository_url="${CODEBUILD_SOURCE_REPO_URL:-https://github.com/placeholder/repo.git}"
            export TF_VAR_repository_branch="${CODEBUILD_SOURCE_VERSION:-main}"

            # Skip ArgoCD validation for infra provisioning
            export SKIP_ARGOCD_VALIDATION=true

            # Generate override.tf for provider role assumption
            echo "Generating override.tf for cross-account access..."
            echo "provider \"aws\" {" > terraform/config/management-cluster/override.tf
            echo "  assume_role {" >> terraform/config/management-cluster/override.tf
            echo "    role_arn = \"${ROLE_ARN}\"" >> terraform/config/management-cluster/override.tf
            echo "  }" >> terraform/config/management-cluster/override.tf
            echo "}" >> terraform/config/management-cluster/override.tf
            
            # Export ASSUME_ROLE_ARN for scripts that need explicit assumption (like bootstrap-argocd.sh)
            export ASSUME_ROLE_ARN="${ROLE_ARN}"
            
            # Run Provision
            echo "Running Provisioning..."
            make pipeline-provision-management
            
            # Cleanup
            rm -f terraform/config/management-cluster/override.tf
            unset ASSUME_ROLE_ARN
        }

        # 1. Process Manual Overrides
        if [[ -n "$MANUAL_TARGET_ACCOUNT_ID" && -n "$MANUAL_TARGET_REGION" && -n "$MANUAL_TARGET_ALIAS" ]]; then
            echo "Detected Manual Configuration Override."
            process_target "$MANUAL_TARGET_ACCOUNT_ID" "$MANUAL_TARGET_REGION" "$MANUAL_TARGET_ALIAS"
        fi

        # 2. Process YAML Files
        echo "Looking for management configurations in deploy/${TARGET_ALIAS}/management/"
        for file in deploy/${TARGET_ALIAS}/management/*.yaml; do
            [ -e "$file" ] || continue
            
            MANAGEMENT_ACCOUNT_ID=$(python3 -c "import yaml; print(yaml.safe_load(open('$file')).get('account_id', ''))")
            REGION=$(python3 -c "import yaml; print(yaml.safe_load(open('$file')).get('region', ''))")
            ALIAS=$(python3 -c "import yaml; print(yaml.safe_load(open('$file')).get('alias', ''))")
            
            if [[ -z "$MANAGEMENT_ACCOUNT_ID" || -z "$REGION" ]]; then
                echo "Skipping invalid config: $file"
                continue
            fi

            process_target "$MANAGEMENT_ACCOUNT_ID" "$REGION" "$ALIAS"
        done
