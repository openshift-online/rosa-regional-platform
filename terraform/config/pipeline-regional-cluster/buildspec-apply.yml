version: 0.2

env:
  shell: bash

phases:
  install:
    commands:
      - echo "Installing dependencies..."
      - yum install -y unzip python3 jq
      - pip3 install boto3 pyyaml
      - echo "Installing Terraform..."
      - curl -O https://releases.hashicorp.com/terraform/1.14.3/terraform_1.14.3_linux_amd64.zip
      - unzip -o terraform_1.14.3_linux_amd64.zip -d /tmp/tf-bin
      - mv /tmp/tf-bin/terraform /usr/local/bin/
      - terraform version

  build:
    commands:
      - echo "Provisioning Regional Cluster Infrastructure..."
      - make pipeline-provision-regional
      - echo "Provisioning Maestro Agent IoT for Regional Cluster..."
      - make provision-maestro-agent-iot-regional

  post_build:
    commands:
      - echo "Infrastructure deployment complete."
      - |
        if [ -f terraform/config/regional-cluster/outputs.json ]; then
          echo "=== Terraform Outputs ==="
          cat terraform/config/regional-cluster/outputs.json
        fi

artifacts:
  files:
    - '**/*'
    - terraform/config/regional-cluster/outputs.json
